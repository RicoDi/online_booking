<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка - Управление бронированиями</title>
    <link rel="stylesheet" href="./admin.css">
</head>
<body>
    <div class="container">
        <h1>Управление бронированиями</h1>

        <!-- Фильтры -->
        <div class="filters">
            <label for="filterMaster">Мастер:</label>
            <select id="filterMaster" onchange="loadBookings()">
                <option value="">Все мастера</option>
            </select>

            <label for="filterDate">Дата:</label>
            <input type="date" id="filterDate" onchange="loadBookings()">

            <label for="filterClient">Клиент:</label>
            <input type="text" id="filterClient" placeholder="Поиск по клиенту" onkeyup="loadBookings()">
        </div>

        <!-- Таблица бронирований -->
        <table id="bookingsTable">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Мастер</th>
                    <th>Услуга</th>
                    <th>Клиент</th>
                    <th>Телефон</th>
                    <th>Email</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="bookingsBody">
                <!-- Бронирования будут добавлены динамически -->
            </tbody>
        </table>
    </div>

    <script>
        // Функция для загрузки бронирований с фильтрацией
        async function loadBookings() {
            const masterId = document.getElementById('filterMaster').value;
            const date = document.getElementById('filterDate').value;
            const client = document.getElementById('filterClient').value.toLowerCase();

            try {
                const response = await fetch(`/api/bookings?master_id=${masterId}&date=${date}&client=${client}`);
                const data = await response.json();
                const bookingsBody = document.getElementById('bookingsBody');

                // Очищаем таблицу перед добавлением новых данных
                bookingsBody.innerHTML = '';

                // Добавляем бронирования в таблицу
                data.bookings.forEach(booking => {
                    const row = `<tr>
                        <td>${new Date(booking.date).toLocaleDateString()}</td>
                        <td>${booking.master_name}</td>
                        <td>${booking.service_name}</td>
                        <td>${booking.name} ${booking.surname}</td>
                        <td>${booking.phone}</td>
                        <td>${booking.email}</td>
                        <td>
                            <button onclick="viewBooking(${booking.id})">Просмотр</button>
                            <button onclick="deleteBooking(${booking.id})">Удалить</button>
                        </td>
                    </tr>`;
                    bookingsBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Ошибка при загрузке бронирований:', error);
            }
        }

        // Функция для загрузки мастеров в фильтр
        async function loadMasters() {
            try {
                const response = await fetch('/api/masters');
                const data = await response.json();
                const masterSelect = document.getElementById('filterMaster');
                
                // Очищаем и добавляем мастеров в список
                masterSelect.innerHTML = '<option value="">Все мастера</option>';
                data.masters.forEach(master => {
                    const option = document.createElement('option');
                    option.value = master.id;
                    option.textContent = `${master.name} ${master.surname}`;
                    masterSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка при загрузке мастеров:', error);
            }
        }

        // Просмотр деталей бронирования
        async function viewBooking(id) {
            try {
                const response = await fetch(`/api/bookings/${id}`);
                const booking = await response.json();

                // Здесь можно реализовать модальное окно с информацией о бронировании
                alert(`
                    Дата: ${new Date(booking.date).toLocaleDateString()}
                    Мастер: ${booking.master_name}
                    Услуга: ${booking.service_name}
                    Клиент: ${booking.name} ${booking.surname}
                    Телефон: ${booking.phone}
                    Email: ${booking.email}
                `);
            } catch (error) {
                console.error('Ошибка при просмотре бронирования:', error);
            }
        }

        // Удаление бронирования
        async function deleteBooking(id) {
            if (confirm('Вы уверены, что хотите удалить это бронирование?')) {
                try {
                    await fetch(`/api/bookings/${id}`, { method: 'DELETE' });
                    loadBookings();
                } catch (error) {
                    console.error('Ошибка при удалении бронирования:', error);
                }
            }
        }

        // Загрузка бронирований и мастеров при загрузке страницы
        window.onload = () => {
            loadMasters();
            loadBookings();
        };
    </script>
</body>
</html>
