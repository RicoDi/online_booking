<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка - Управление услугами</title>
    <link rel="stylesheet" href="/admin.css">
</head>
<body>
    <div class="container">
        <h1>Управление услугами</h1>

        <!-- Поиск услуг -->
        <input type="text" id="search" placeholder="Поиск услуг..." onkeyup="filterServices()">

        <!-- Таблица услуг -->
        <table id="servicesTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Название услуги</th>
                    <th onclick="sortTable(1)">Мастер</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="servicesBody">
                <!-- Услуги будут добавлены динамически -->
            </tbody>
        </table>

        <!-- Кнопка для добавления услуги -->
        <button onclick="openAddServiceForm()">Добавить услугу</button>

        <!-- Форма добавления/редактирования услуги -->
        <div id="serviceForm" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeServiceForm()">&times;</span>
                <h2 id="formTitle">Добавить услугу</h2>
                <form id="serviceFormData">
                    <input type="hidden" id="serviceId" name="serviceId">
                    <label for="name">Название услуги</label>
                    <input type="text" id="name" name="name" required>
                    <label for="master">Мастер</label>
                    <select id="master" name="master" required></select>
                    <button type="submit" id="saveServiceButton">Сохранить</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Функция для получения услуг с сервера
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();
                const servicesBody = document.getElementById('servicesBody');

                // Очищаем таблицу перед добавлением новых данных
                servicesBody.innerHTML = '';

                // Добавляем услуги в таблицу
                data.services.forEach(service => {
                    const row = `<tr>
                        <td>${service.name}</td>
                        <td>${service.master_name}</td>
                        <td>
                            <button onclick="editService(${service.id})">Редактировать</button>
                            <button onclick="deleteService(${service.id})">Удалить</button>
                        </td>
                    </tr>`;
                    servicesBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Ошибка при загрузке услуг:', error);
            }
        }

        // Фильтр поиска по услугам
        function filterServices() {
            const input = document.getElementById('search');
            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll('#servicesBody tr');

            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const master = row.cells[1].textContent.toLowerCase();
                if (name.includes(filter) || master.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Открыть форму добавления услуги
        async function openAddServiceForm() {
            document.getElementById('serviceForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Добавить услугу';
            document.getElementById('serviceFormData').reset();
            loadMasters(); // Загружаем мастеров в выпадающий список

            document.getElementById('saveServiceButton').onclick = saveService;
        }

        // Открыть форму для редактирования услуги
        async function editService(id) {
            document.getElementById('serviceForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Редактировать услугу';
            loadMasters(); // Загружаем мастеров в выпадающий список

            try {
                const response = await fetch(`/api/services/${id}`);
                const service = await response.json();
                document.getElementById('serviceId').value = service.id;
                document.getElementById('name').value = service.name;
                document.getElementById('master').value = service.master_id;
                document.getElementById('saveServiceButton').onclick = () => saveService(id);
            } catch (error) {
                console.error('Ошибка при загрузке услуги:', error);
            }
        }

        // Сохранение услуги (добавление или обновление)
        async function saveService(id = null) {
            const service = {
                name: document.getElementById('name').value,
                master_id: document.getElementById('master').value
            };
            const url = id ? `/api/services/${id}` : '/api/services';
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(service)
                });
                closeServiceForm();
                loadServices();
            } catch (error) {
                console.error('Ошибка при сохранении услуги:', error);
            }
        }

        // Удаление услуги
        async function deleteService(id) {
            try {
                await fetch(`/api/services/${id}`, { method: 'DELETE' });
                loadServices();
            } catch (error) {
                console.error('Ошибка при удалении услуги:', error);
            }
        }

        // Закрытие формы
        function closeServiceForm() {
            document.getElementById('serviceForm').style.display = 'none';
        }

        // Функция для загрузки списка мастеров
        async function loadMasters() {
            try {
                const response = await fetch('/api/masters');
                const data = await response.json();
                const masterSelect = document.getElementById('master');
                masterSelect.innerHTML = '';

                data.masters.forEach(master => {
                    const option = document.createElement('option');
                    option.value = master.id;
                    option.textContent = `${master.name} ${master.surname}`;
                    masterSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка при загрузке мастеров:', error);
            }
        }

        // Загрузка услуг при загрузке страницы
        window.onload = loadServices;
    </script>
</body>
</html>
